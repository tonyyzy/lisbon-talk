<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">

  <title>Lisbon</title>

  <meta name="description" content="A framework for easily creating beautiful presentations using HTML">
  <meta name="author" content="Hakim El Hattab">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="libs/reveal.js/4.3.1/reset.css">
  <link rel="stylesheet" href="libs/reveal.js/4.3.1/reveal.css">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  <!-- highlight Theme -->
  
  <link rel="stylesheet" href="libs/highlight.js/11.3.1/styles/monokai.min.css">
  
	
		
	<link rel="stylesheet" href="libs/reveal.js/4.3.1/plugin/chalkboard/style.css">
	
	
	
  <link rel="stylesheet" href="libs/reveal.js/4.3.1/plugin/customcontrols/style.css">
  
	



  <!-- Revealjs Theme -->
  
  <link rel="stylesheet" href="libs/reveal.js/4.3.1/theme/white.css" id="theme">
  
  

  <link rel="stylesheet" href="libs/styles/tasklist.css">
	<link rel="stylesheet" href="libs/styles/iota.css">
	<link rel="stylesheet" href="libs/styles/layout.css">


  <!-- Revealjs Theme -->
  

   <!-- css list -->
	

   

</head>

<body>

   

  <div class="reveal">

    <!-- Any section element inside of this container is displayed as a slide -->
    <div class="slides">

      


    
        <section >
            
            <style>
    .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5 {
      text-transform: none;
    }

    .reveal p {
      font-size: 0.8em;
      vertical-align: top;
    }

    .reveal li {
      font-size: 0.8em;
      vertical-align: top;
    }

    .reveal section img {
      background:none;
      border:none;
      box-shadow:none;
    }

    table, th, td {
      border: 0.2px solid black;
      border-collapse: collapse;
      font-size: 0.7em;
    }

    code {
      color: brown;
    }

    .reveal pre{
      font-size: 0.4em;
      line-height: 1.4em;
      width: 95%;
    }

    .reveal pre code{
      max-height: 550px;
    }
</style>
<h1>Speed Up SVM Some More with Rust</h1>
<p style="text-align:right">Tony Yang (Arabesque AI)</p>
<p style="text-align:right"><svg style="width:24px;height:24px" viewBox="0 0 24 24" transform="translate(-10 3) scale(2 2)">
<path fill="currentColor" d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z" />
</svg>:  <a href="https://www.linkedin.com/in/tonyyzy" target="_blank" rel="noopener noreferrer">tonyyzy</a>
</p>
<p style="text-align:right"><svg style="width:24px;height:24px" viewBox="0 0 24 24" transform="translate(-10 3) scale(2 2)">
<path fill="currentColor" d="M19 3A2 2 0 0 1 21 5V19A2 2 0 0 1 19 21H5A2 2 0 0 1 3 19V5A2 2 0 0 1 5 3H19M18.5 18.5V13.2A3.26 3.26 0 0 0 15.24 9.94C14.39 9.94 13.4 10.46 12.92 11.24V10.13H10.13V18.5H12.92V13.57C12.92 12.8 13.54 12.17 14.31 12.17A1.4 1.4 0 0 1 15.71 13.57V18.5H18.5M6.88 8.56A1.68 1.68 0 0 0 8.56 6.88C8.56 5.95 7.81 5.19 6.88 5.19A1.69 1.69 0 0 0 5.19 6.88C5.19 7.81 5.95 8.56 6.88 8.56M8.27 18.5V10.13H5.5V18.5H8.27Z" />
</svg>: <a href="https://github.com/tonyyzy" target="_blank" rel="noopener noreferrer">tonyyzy</a></p>
<p style="text-align:right">
<svg style="width:24px;height:24px" viewBox="0 0 24 24" transform="translate(-10 3) scale(2 2)">
<path fill="currentColor" d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.27C8.28,9.09 5.11,7.38 3,4.79C2.63,5.42 2.42,6.16 2.42,6.94C2.42,8.43 3.17,9.75 4.33,10.5C3.62,10.5 2.96,10.3 2.38,10C2.38,10 2.38,10 2.38,10.03C2.38,12.11 3.86,13.85 5.82,14.24C5.46,14.34 5.08,14.39 4.69,14.39C4.42,14.39 4.15,14.36 3.89,14.31C4.43,16 6,17.26 7.89,17.29C6.43,18.45 4.58,19.13 2.56,19.13C2.22,19.13 1.88,19.11 1.54,19.07C3.44,20.29 5.7,21 8.12,21C16,21 20.33,14.46 20.33,8.79C20.33,8.6 20.33,8.42 20.32,8.23C21.16,7.63 21.88,6.87 22.46,6Z" />
</svg>: <a href="https://twitter.com/tony_yzy" target="_blank" rel="noopener noreferrer">tony_yzy</a>
</p>
<p style="text-align:right">Slides: <a href="https://tonyyzy.github.io/lisbon-talk" target="_blank" rel="noopener noreferrer">tonyyzy.github.io/lisbon-talk</a></p>
<aside class="notes">
Hi everyone, today I'll talk about a project I completed last year, during my internship at arabesque AI.
</aside>
            </section>
    



    
        <section >
            
            <h2>Background</h2>
<ul>
<li class="fragment fade-in">Use machine learning models to analyse stock market trends</li>
<li class="fragment fade-in">Python machine learning library <code>scikit-learn</code></li>
<li class="fragment fade-in">Support vector machine (SVM) in <code>scikit-learn</code> binds to <code>liblinear</code></li>
</ul>
<aside class="notes">
Arabesque is an asset management company and we use a variety of classical machine learning and deep learning techniques to analyse stock market trends.
<p>Part of my work was to look for ways to reduce our models training and inference time.</p>
<p>We used Scikit learn for most of the classical models and SVM takes the longest training time in our workflow.</p>
<p>Intel has an optimised library for scikit learn but they didnâ€™t include linearSVC models.</p>
<p>It could be a dead end but curiousity drove me to peek under the cover and look into the underlying C++ library that scikit learn uses.
And I realised there were some opportunities for optimisation.</p>
<p>So without further ado, Iâ€™ll present you the project outcome first.</p>
</aside>
            </section>
    



    
    <section>
        <section >
            <h2>Lisbon</h2>
<ul>
<li class="fragment fade-in">Reimplementation of <code>liblinear</code>â€™s L2-regularised hinge-loss routine in <strong>Rust</strong> ðŸ¦€</li>
<li class="fragment fade-in">Faithfully reproduce <code>scikit-learn</code>â€™s results</li>
<li class="fragment fade-in">Minimal memory overhead</li>
<li class="fragment fade-in">20-30% faster than <code>scikit-learn</code></li>
</ul>
<aside class="notes">
In project lisbon, I reimplemented one of liblinear's subroutine in Rust.
Lisbon faithfully reproduce scikit learn's results and incurs minimal memory overhead.
We reduce the memory usage by half in some big datasets compared to liblinear.
And finally, we achieved a speed up of 20-30%.
</aside>
            </section>
        
            <section >
                <h3>Howâ€™s it faster</h3>
<ol>
<li class="fragment fade-in">
<p><code>liblinear</code> uses sparse matrix representation for the dot/norm operations which is inefficient for our use case</p>
</li>
<li class="fragment fade-in">
<p>By reading NumPyâ€™s underneath C array directly thereâ€™s no need to copy/duplicate data so saves memory</p>
</li>
<li class="fragment fade-in">
<p>Specialised. Some array reads and computations are optimised away as we know the values for our specific problem</p>
</li>
</ol>
<aside class="notes">
Lisbon is faster basically because of these three points
<p>I will talk about matrix memory representation in a bit more detail</p>
<p>I will explain where the memory saving and speed up come from in the rest of the talk.
It wonâ€™t be deeply technical and I will spend some time talk about this porting and tooling experience as well.</p>
</aside>
            </section>
        

    </section>
    



    
        <section >
            
            <h2>Support Vector Machine</h2>
<img src="https://upload.wikimedia.org/wikipedia/commons/7/72/SVM_margin.png" alt="SVM margin illustration" height="400"/>
<p style="font-size:16px"><a href="https://commons.wikimedia.org/wiki/File:SVM_margin.png">Wikipedia. 2022. "Support vector machine."</a></p>
<aside class="notes">
For people unfamiliar with SVM here, I will give a very brief introduction for context.
<p>Essentially, SVM is a classification technique.</p>
<p>We have datapoints belong to differnt classes and our goal is to find the line that separates the points into two groups.</p>
</aside>
            </section>
    



    
    <section>
        <section >
            <h3>Matrix Operations</h3>
<ul>
<li class="fragment fade-in">
<p>Matrix operations take majority of the CPU-cycles</p>
</li>
<li class="fragment fade-in">
<p>In SVMâ€™s coordinate descent algorithm, matrix/vector dot product is a hot path to optimise</p>
</li>
</ul>

            </section>
        
            <section >
                <h3>Matrix Representation in Memory</h3>
<table>
      <tr>
        <td style="background-color:lightyellow">a<sub>11</sub></td>
        <td style="background-color:lightyellow">a<sub>12</sub></td>
        <td style="background-color:lightyellow">a<sub>13</sub></td>
        <td style="background-color:lightyellow">a<sub>14</sub></td>
      </tr>
      <tr>
        <td style="background-color:lightblue">a<sub>21</sub></td>
        <td style="background-color:lightblue">a<sub>22</sub></td>
        <td style="background-color:lightblue">a<sub>23</sub></td>
        <td style="background-color:lightblue">a<sub>24</sub></td>
      </tr>
      <tr>
        <td style="background-color:lightgreen">a<sub>31</sub></td>
        <td style="background-color:lightgreen">a<sub>32</sub></td>
        <td style="background-color:lightgreen">a<sub>33</sub></td>
        <td style="background-color:lightgreen">a<sub>34</sub></td>
      </tr>
      <tr>
        <td style="background-color:lightpink">a<sub>41</sub></td>
        <td style="background-color:lightpink">a<sub>42</sub></td>
        <td style="background-color:lightpink">a<sub>43</sub></td>
        <td style="background-color:lightpink">a<sub>44</sub></td>
      </tr>
    </table>
            </section>
        
            <section >
                <h3>Matrix Representation in Memory</h3>
<ul>
<li>But memory address is one-dimensional</li>
<li class="fragment fade-in" data-fragment-index="0">Row-major (C style)</li>
</ul>
<table class="fragment fade-in" data-fragment-index="0">
  <tr>
    <td style="background-color:lightyellow">a<sub>11</sub></td>
    <td style="background-color:lightyellow">a<sub>12</sub></td>
    <td style="background-color:lightyellow">a<sub>13</sub></td>
    <td style="background-color:lightyellow">a<sub>14</sub></td>
    <td style="background-color:lightblue">a<sub>21</sub></td>
    <td style="background-color:lightblue">a<sub>22</sub></td>
    <td style="background-color:lightblue">a<sub>23</sub></td>
    <td style="background-color:lightblue">a<sub>24</sub></td>
    <td style="background-color:lightgreen">a<sub>31</sub></td>
    <td style="background-color:lightgreen">a<sub>32</sub></td>
    <td style="background-color:lightgreen">a<sub>33</sub></td>
    <td style="background-color:lightgreen">a<sub>34</sub></td>
    <td style="background-color:lightpink">a<sub>41</sub></td>
    <td style="background-color:lightpink">a<sub>42</sub></td>
    <td style="background-color:lightpink">a<sub>43</sub></td>
    <td style="background-color:lightpink">a<sub>44</sub></td>
  </tr>
</table>
<ul>
<li class="fragment fade-in" data-fragment-index="1">Column-major (Fortran style/pandas maybe)</li>
</ul>
<table class="fragment fade-in" data-fragment-index="1">
  <tr>
    <td style="background-color:lightyellow">a<sub>11</sub></td>
    <td style="background-color:lightblue">a<sub>21</sub></td>
    <td style="background-color:lightgreen">a<sub>31</sub></td>
    <td style="background-color:lightpink">a<sub>41</sub></td>
    <td style="background-color:lightyellow">a<sub>12</sub></td>
    <td style="background-color:lightblue">a<sub>22</sub></td>
    <td style="background-color:lightgreen">a<sub>32</sub></td>
    <td style="background-color:lightpink">a<sub>42</sub></td>
    <td style="background-color:lightyellow">a<sub>13</sub></td>
    <td style="background-color:lightblue">a<sub>23</sub></td>
    <td style="background-color:lightgreen">a<sub>33</sub></td>
    <td style="background-color:lightpink">a<sub>43</sub></td>
    <td style="background-color:lightyellow">a<sub>14</sub></td>
    <td style="background-color:lightblue">a<sub>24</sub></td>
    <td style="background-color:lightgreen">a<sub>34</sub></td>
    <td style="background-color:lightpink">a<sub>44</sub></td>
  </tr>
</table>
<ul>
<li class="fragment fade-in" data-fragment-index="2">Sparse matrix representation (<code>liblinear</code>)</li>
</ul>
<table class="fragment fade-in" data-fragment-index="2">
  <tr>
    <td style="background-color:lightyellow">(1, a<sub>11</sub>)</td>
    <td style="background-color:lightyellow">(-1, null)</td>
    <td style="background-color:lightblue">(-1, null)</td>
    <td style="background-color:lightgreen">(-1, null)</td>
    <td style="background-color:lightpink">(4, a<sub>44</sub>)</td>
    <td style="background-color:lightpink">(-1, null)</td>
  </tr>
</table>
            </section>
        
            <section >
                <h4>Matrix Representation in Memory</h4>
<ul>
<li class="fragment fade-in">
<p>Our encoded data is not sparse at all (~0.007% of values are 0.0)</p>
</li>
<li class="fragment fade-in">
<p><code>scikit-learn</code> needs to convert the dense matrix to sparse representation then pass to <code>liblinear</code></p>
</li>
<li class="fragment fade-in">
<p>This takes time and a lot of additional memory (~1.5x because of the index)</p>
</li>
<li class="fragment fade-in">
<p><code>lisbon</code> reads the memory directly without making a copy, Rust/PyO3 enforces compile time guarantee that the memory is read-only</p>
</li>
</ul>

            </section>
        
            <section >
                <h2>Matrix Operations in Rust</h2>
<pre><code class="language-rust">pub struct BLASOperator;

impl BLASOperator {
    #[inline]
    pub fn nrm2_sq(x: &amp;[f64]) -&gt; f64 {
        x.iter().map(|a| a * a).sum()
    }

    #[inline]
    pub fn dot(s: &amp;[f64], x: &amp;[f64]) -&gt; f64 {
        s.iter().zip(x.iter()).map(|(a, b)| a * b).sum()
    }

    #[inline]
    pub fn axpy(a: f64, x: &amp;[f64], y: &amp;mut [f64]) {
        for (i, &amp;j) in y.iter_mut().zip(x.iter()) {
            *i = a.mul_add(j, *i)
        }
    }
}
</code></pre>

            </section>
        
            <section >
                <h3>SIMD and Cache Efficiency</h3>
<ul>
<li class="fragment fade-in">Single Instruction Multiple Data</li>
<li class="fragment fade-in">Calculate multiple operations simultaneously</li>
<li class="fragment fade-in">Dense representation allows SIMD operations (via auto-vectorisation)</li>
<li class="fragment fade-in">Row-major densely packed C-style matrix representation allows efficient use of cache lines</li>
</ul>

            </section>
        

    </section>
    



    
        <section >
            
            <h3>Benchmark</h3>
<ul>
<li>small: 48842 rows of data and 14 features.</li>
<li>medium: 210447 rows of data and 1000 features.</li>
<li>large: 747922 rows of data and 1000 features.</li>
</ul>
<!-- prettier-ignore-start -->
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center" colspan="2">Small</th>
<th style="text-align:center" colspan="2">Medium</th>
<th style="text-align:center" colspan="2">Large</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">library</td>
<td style="text-align:center">time (s)</td>
<td style="text-align:center">memory (MB)</td>
<td style="text-align:center">time (s)</td>
<td style="text-align:center">memory (MB)</td>
<td style="text-align:center">time (s)</td>
<td style="text-align:center">memory (MB)</td>
</tr>
<tr>
<td style="text-align:center"><code>lisbon</code> with <code>cpu=native</code></td>
<td style="text-align:center">3.725</td>
<td style="text-align:center">127.9</td>
<td style="text-align:center">25.569</td>
<td style="text-align:center">2539.4</td>
<td style="text-align:center">50.791</td>
<td style="text-align:center">8742.1</td>
</tr>
<tr>
<td style="text-align:center"><code>lisbon</code> without <code>cpu=native</code></td>
<td style="text-align:center">5.784</td>
<td style="text-align:center">127.8</td>
<td style="text-align:center">38.162</td>
<td style="text-align:center">2538.5</td>
<td style="text-align:center">76.959</td>
<td style="text-align:center">8741.7</td>
</tr>
<tr>
<td style="text-align:center"><code>liblinear</code></td>
<td style="text-align:center">6.473</td>
<td style="text-align:center">137.4</td>
<td style="text-align:center">41.096</td>
<td style="text-align:center">5765.0</td>
<td style="text-align:center">84.259</td>
<td style="text-align:center">20205.0</td>
</tr>
</tbody>
</table>
<!-- prettier-ignore-end -->
            </section>
    



    
    <section>
        <section >
            <h4>Zero-copy Matrix Access</h4>
<pre><code class="language-rust">use numpy::PyReadonlyArray2;

fn dense_to_slices&lt;'a&gt;(arr: &amp;'a PyReadonlyArray2&lt;f64&gt;) -&gt; Vec&lt;&amp;'a [f64]&gt; {
    let n = arr.shape()[1];
    arr.as_slice().unwrap().chunks(n).collect()
}
</code></pre>
<aside class="notes">
<aside>
            </section>
        
            <section >
                <h4>Zero-copy Matrix Access</h4>
<pre><code class="language-rust">pub struct Problem&lt;'a&gt; {
    l: usize,           // number of training data
    n: usize,           // number of features
    y: &amp;'a [f64],       // array of target values
    x: Vec&lt;&amp;'a [f64]&gt;,  // array of training vectors
}
</code></pre>

            </section>
        

    </section>
    



    
        <section >
            
            <h2>Project Timeline</h2>
<ul>
<li>Porting <code>liblinear</code> subroutine to Rust (~4 days)</li>
<li>Develop Python binding (~3 days)</li>
</ul>

            </section>
    



    
    <section>
        <section >
            <h3>PyO3 and Maturin</h3>
<ul>
<li>PyO3 provides macros for wrapping Rust functions inside a Python module</li>
</ul>
<pre><code class="language-Rust">#[pymodule]
fn lisbon(_py: Python, m: &amp;PyModule) -&gt; PyResult&lt;()&gt; {
    m.add_function(wrap_pyfunction!(set_verbosity_wrap, m)?)?;
    #[pyfn(m)]
    fn train_wrap&lt;'py&gt;(
        ...
</code></pre>

            </section>
        
            <section >
                <h3>PyO3 and Maturin</h3>
<ul>
<li>Maturin makes Python packaging and publishing incredibly easy</li>
</ul>
<pre><code class="language-bash">maturin develop --release # build and install as Python library

# GitHub action to publish to PyPI
# 3 OS x 5 Python versions
maturin publish --skip-existing -i python -u __token__ -p ${{ secrets.MATURIN_PASSWORD }}
</code></pre>

            </section>
        
            <section >
                <h3>Drop-in Replacement</h3>
<pre><code class="language-python">from sklearn import svm
import lisbon

# essentially monkey patch as following
# svm._base.liblinear = lisbon
</code></pre>
<aside class="notes">
To substitute liblinear with lisbon in sklearn only requires minimal code changes. Here you can see we monkey-patched the svm's liblinear library with lisbon. In the future, I plan on doing this during the lisbon's import process. So all you have to do is to import the lisbon package and it will check for svm function call arguments and cpu architecture then patch the library at run time.
</aside>
            </section>
        

    </section>
    



    
        <section >
            
            <h3>Final Remark</h3>
<ul>
<li class="fragment fade-in">The module is purely in Rust (with a little Python for auto-patching), no need for Cython as glue code</li>
<li class="fragment fade-in">Speed up is not due to Rust</li>
<li class="fragment fade-in">â€¦but the language and tooling makes development process efficient</li>
</ul>
<aside class="notes">
So technically the speed up was not because of Rust, I couldn't lie about that. But the language gave me more safety guarantee and the confidence to optimise the code.
</aside>
            </section>
    



    
        <section >
            
            <h2>Links</h2>
<ul>
<li>
<p>Repository: <a href="https://github.com/arabesqueai/lisbon">github.com/arabesqueai/lisbon</a></p>
</li>
<li>
<p>Medium blog post: <a href="https://tinyurl.com/lisbon-svm">tinyurl.com/lisbon-svm</a></p>
</li>
</ul>

            </section>
    


    </div>


  </div>

  <div class="line top"></div>
  <div class="line bottom"></div>
  <div class="line left"></div>
  <div class="line right"></div>

  <script src="libs/reveal.js/4.3.1/reveal.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/notes/notes.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/markdown/markdown.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/highlight/highlight.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/math/math.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/fullscreen/plugin.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/animate/plugin.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/animate/svg.min.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/anything/plugin.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/anything/Chart.min.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/anything/d3/d3.v3.min.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/anything/d3.patch.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/anything/d3/queue.v1.min.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/anything/d3/topojson.v1.min.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/anything/function-plot.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/customcontrols/plugin.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/embed-tweet/plugin.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/chart/chart.min.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/chart/plugin.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/verticator/verticator.js"></script>

<script src="libs/reveal.js/4.3.1/plugin/zoom/zoom.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/search/search.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/menu/menu.js"></script>
<script src="libs/reveal.js/4.3.1/plugin/chalkboard/plugin.js"></script>

<!--	<script src="libs/reveal.js/4.3.1/plugin/audio-slideshow/plugin.js"></script>  -->
<!--	<script src="libs/reveal.js/4.3.1/plugin/audio-slideshow/recorder.js"></script>-->
<!--	<script src="libs/reveal.js/4.3.1/plugin/audio-slideshow/RecordRTC.js"></script>-->

  

<script>
  const printPlugins = [
      RevealNotes,
      RevealHighlight,
      RevealMath.MathJax3,
      RevealAnimate,
      RevealChalkboard, 
			RevealEmbedTweet,
			RevealChart,
		];

		const plugins =  [...printPlugins,
		RevealZoom, 
		RevealSearch, 
				RevealMarkdown, 
				RevealMenu, 
				RevealFullscreen,
				RevealAnything,
				//RevealAudioSlideshow,
				//RevealAudioRecorder,
				RevealCustomControls, 
				// poll
				// question
				// seminar
				Verticator 
				 ]


		// Also available as an ES module, see:
		// https://revealjs.com/initialization/
		Reveal.initialize({
			controls: true,
      controlsTutorial: true,
      controlsLayout: 'bottom-right',
      controlsBackArrows: 'faded',
      progress: true,
      slideNumber: true,
      //#showSlideNumber "all" "print" "speaker"
      hash: true, //# hash: false,
      //# respondToHashChanges: true,
      //# history: false,
      keyboard: true,
      //#keyboardCondition: null,
      overview: true,
      center: true,
      touch: true,
      loop: false,
      rtl: false,
      //#navigationMode: 'default', linear grid
      shuffle: false,
      fragments: true,
      fragmentInURL: false,
      embedded: false,
      help: true,
      //#pause: true
      showNotes: false,
      autoPlayMedia: false, // TODO fix this to a nullable value
      //#preloadIframes: null. true false
      //#autoAnimate: true
      //#autoAnimateMatcher: null,
      //#autoAnimateEasing: 'ease',
      //autoAnimateDuration: 1.0,
      //#autoAnimateUnmatched: true
      //#autoAnimateStyles: []
      autoSlide: 0, // TODO fix this to a falseable value
      autoSlideStoppable: true,
      autoSlideMethod: '0',
      defaultTiming: 120,
      mouseWheel: false,
      //#previewLinks: false
      //#postMessage: true, // TODO : this can cause issues with the vscode api ???
      //#postMessageEvents: false,
      //#focusBodyOnPageVisibilityChange: true,
      transition: 'none',
      transitionSpeed: 'default',
      backgroundTransition: 'fade',
      //#pdfMaxPagesPerSlide: Number.POSITIVE_INFINITY,
      //#pdfSeparateFragments: true,
      //#pdfPageHeightOffset: -1,
      viewDistance: 3,
      //#mobileViewDistance: 2,
      display: 'block',
      //#hideInactiveCursor: true,
      //#hideCursorTime: 5000

      // Parallax Background
      parallaxBackgroundImage: '',
      parallaxBackgroundSize: '',
      parallaxBackgroundHorizontal: 0,
      parallaxBackgroundVertical: 0,

      //Presentation Size
      width: 960,
			height: 700,
			margin: 0.04,
      minScale: 0.2,
      maxScale: 2,
      disableLayout: false,

      audio: {
        prefix: 'audio/', // audio files are stored in the "audio" folder
        suffix: '.ogg', // audio files have the ".ogg" ending
        textToSpeechURL: null, // the URL to the text to speech converter
        defaultNotes: false, // use slide notes as default for the text to speech converter
        defaultText: false, // use slide text as default for the text to speech converter
        advance: 0, // advance to next slide after given time in milliseconds after audio has played, use negative value to not advance
        autoplay: false, // automatically start slideshow
        defaultDuration: 5, // default duration in seconds if no audio is available
        defaultAudios: true, // try to play audios with names such as audio/1.2.ogg
        playerOpacity: 0.05, // opacity value of audio player if unfocused
        playerStyle: 'position: fixed; bottom: 4px; left: 25%; width: 50%; height:75px; z-index: 33;', // style used for container of audio controls
        startAtFragment: false, // when moving to a slide, start at the current fragment or at the start of the slide
      },
      
      chalkboard: { // font-awesome.min.css must be available
        //src: "chalkboard/chalkboard.json",
        storage: "chalkboard-demo",
      },
      
			customcontrols: {
					controls: [
      						{
						  id: 'toggle-overview',
						  title: 'Toggle overview (O)',
						  icon: '<i class="fa fa-th"></i>',
						  action: 'Reveal.toggleOverview();'
						}
						,
      {
        icon: '<i class="fa fa-pen-square"></i>',
        title: 'Toggle chalkboard (B)',
        action: 'RevealChalkboard.toggleChalkboard();'
      },
      {
        icon: '<i class="fa fa-pen"></i>',
        title: 'Toggle notes canvas (C)',
        action: 'RevealChalkboard.toggleNotesCanvas();'
      }
      
				]
			},
			chart: {
					defaults: { 
						color: 'lightgray', // color of labels
						scale: { 
							beginAtZero: true, 
							ticks: { stepSize: 1 },
							grid: { color: "lightgray" } , // color of grid lines
						},
					},
					line: { borderColor: [ "rgba(20,220,220,.8)" , "rgba(220,120,120,.8)", "rgba(20,120,220,.8)" ], "borderDash": [ [5,10], [0,0] ] }, 
					bar: { backgroundColor: [ "rgba(20,220,220,.8)" , "rgba(220,120,120,.8)", "rgba(20,120,220,.8)" ]}, 
					pie: { backgroundColor: [ ["rgba(0,0,0,.8)" , "rgba(220,20,20,.8)", "rgba(20,220,20,.8)", "rgba(220,220,20,.8)", "rgba(20,20,220,.8)"] ]},
					radar: { borderColor: [ "rgba(20,220,220,.8)" , "rgba(220,120,120,.8)", "rgba(20,120,220,.8)" ]}, 
			},
			math: {
				mathjax: 'https://cdn.jsdelivr.net/gh/mathjax/mathjax@2.7.8/MathJax.js',
				config: 'TeX-AMS_HTML-full',
				// pass other options into `MathJax.Hub.Config()`
				TeX: { Macros: { RR: "{\\bf R}" } }
				},
				anything: [ 
				{
		className: "plot",
		defaults: {width:500, height: 500, grid:true},
		initialize: (function(container, options){ options.target = "#"+container.id; functionPlot(options) })
	 },
	 {
		className: "chart",  
		initialize: (function(container, options){ container.chart = new Chart(container.getContext("2d"), options);  })
	 },
	 {
		className: "anything",
		initialize: (function(container, options){ if (options && options.initialize) { options.initialize(container)} })
	 },
					],
			// Learn about plugins: https://revealjs.com/plugins/
			plugins: (window.location.search.match(/print-pdf/gi) ? printPlugins : plugins ) 
		});
			


	    // Change chalkboard theme : 
		function changeTheme(input) {
			var config = {};
			config.theme = input.value;
			Reveal.getPlugin("RevealChalkboard").configure(config);
			input.blur();
		}

		// // Handle the message inside the webview
        // window.addEventListener('message', event => {

        //     const message = event.data; // The JSON data our extension sent

        //     switch (message.command) {
        //         case 'refactor':
        //             Reveal.toggleHelp();
        //     }
        // });

		if (window.location.search.match(/print-pdf-now/gi)) {
      		setTimeout(() => {
				window.print();
			  }, 2500);
			
    }
</script>

</body>

</html>